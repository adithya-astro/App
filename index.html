<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Budget</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #28a745; --bg: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; padding: 15px; background: var(--bg); margin: 0; }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h2, h3 { margin-top: 0; color: #333; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 15px; border-radius: 12px; text-align: center; }
        .stat-val { display: block; font-size: 1.4rem; font-weight: bold; color: var(--primary); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-save { background: var(--primary); color: white; }
        .btn-file { background: #6c757d; color: white; margin-bottom: 10px; }
        .day-detail { border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px; }
        .meal-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #ccc; }
    </style>
</head>
<body>

    <button class="btn btn-file" onclick="openFile()">ðŸ“‚ Load Budget File</button>

    <div class="stats-grid">
        <div class="stat-box">
            <span class="stat-label">Month Total</span>
            <span class="stat-val" id="monthTotal">$0</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">Daily Avg</span>
            <span class="stat-val" id="dailyAvg">$0</span>
        </div>
    </div>

    <div class="card">
        <h3>Daily Tracker</h3>
        <input type="date" id="datePicker" onchange="renderDay()">
        <div id="dayContent" class="day-detail">
            <div class="meal-row"><span>Breakfast:</span><input type="number" id="meal_b" placeholder="0" onchange="updateDaily()"></div>
            <div class="meal-row"><span>Lunch:</span><input type="number" id="meal_l" placeholder="0" onchange="updateDaily()"></div>
            <div class="meal-row"><span>Dinner:</span><input type="number" id="meal_d" placeholder="0" onchange="updateDaily()"></div>
            <div class="meal-row"><span>Other:</span><input type="number" id="meal_o" placeholder="0" onchange="updateDaily()"></div>
            <h4 style="text-align: right;">Day Total: Rs: <span id="dayTotal">0</span></h4>
        </div>
    </div>

    <button class="btn btn-file" style="background:#007bff" onclick="saveToFile()">ðŸ’¾ Sync to Phone</button>

    <script>
        /let fileHandle;

// 1. On Load, check if we have a "saved" file reference
window.onload = async () => {
    const savedHandle = await getFileFromDB();
    if (savedHandle) {
        fileHandle = savedHandle;
        document.getElementById('status').innerText = "ðŸ“‚ Found your file. Click 'Verify' to sync.";
    }
    loadFromCache(); // Always load memory first so it's instant
};

// 2. The ONE click required to link/verify the file
async function verifyAndLinkFile() {
    try {
        if (!fileHandle) {
            // First time setup: Pick the file
            [fileHandle] = await window.showOpenFilePicker();
            await saveFileToDB(fileHandle);
        }

        // Request permission to read/write
        const options = { mode: 'readwrite' };
        if (await fileHandle.queryPermission(options) !== 'granted') {
            if (await fileHandle.requestPermission(options) !== 'granted') {
                alert("Permission denied");
                return;
            }
        }

        // Load data from that file
        const file = await fileHandle.getFile();
        const content = await file.text();
        budgetData = JSON.parse(content);
        
        localStorage.setItem('budgetData', JSON.stringify(budgetData));
        document.getElementById('status').innerText = "âœ… File Synced & Verified";
        refreshUI();
    } catch (e) {
        console.error(e);
        alert("Could not sync file.");
    }
}

// 3. Automatic "Silent" Save
async function autoSaveToFile() {
    if (!fileHandle) return; // Skip if file isn't linked
    
    try {
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(budgetData));
        await writable.close();
        console.log("Automatically synced to .txt file");
    } catch (e) {
        console.log("Background save failed - permission may have expired.");
    }
}

// Trigger this inside your updateData() function
function updateData() {
    // ... (your existing update logic) ...
    localStorage.setItem('budgetData', JSON.stringify(budgetData));
    autoSaveToFile(); // <--- This tries to write to the .txt silently
    refreshUI();
}

// --- IndexedDB Helpers (To remember the file handle) ---
function saveFileToDB(handle) {
    const request = indexedDB.open("FileStorage", 1);
    request.onupgradeneeded = e => e.target.result.createObjectStore("handles");
    request.onsuccess = e => {
        const db = e.target.result;
        db.transaction("handles", "readwrite").objectStore("handles").put(handle, "currentFile");
    };
}

async function getFileFromDB() {
    return new Promise((resolve) => {
        const request = indexedDB.open("FileStorage", 1);
        request.onupgradeneeded = e => e.target.result.createObjectStore("handles");
        request.onsuccess = e => {
            const db = e.target.result;
            const getReq = db.transaction("handles").objectStore("handles").get("currentFile");
            getReq.onsuccess = () => resolve(getReq.result);
        };
    });
}
    </script>
</body>
</html>